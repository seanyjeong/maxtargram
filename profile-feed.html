<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>사용자 프로필</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/feed.css">
  <style>
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      display: flex;
      justify-content: space-around; /* ✅ 버튼 균등하게 배치 */
      align-items: center;
      padding: 6px 0;
      border-top: 1px solid #ccc;
      max-width: 480px;  /* ✅ 너무 넓어지지 않게 고정 */
      margin: 0 auto;
      z-index: 999;
    }
    
    .bottom-nav button {
      background: none;
      border: none;
      font-size: 1.2rem;  /* ✅ 적당한 크기로 줄이기 */
      padding: 4px;
      flex: 1;
      text-align: center;
    }
    .bottom-nav .plus-btn {
      font-size: 1.6rem;       /* 가운데만 살짝 강조 */
      transform: translateY(-4px); /* 약간 위로 띄우면 감성 😎 */
    }
    
    </style>
</head>
<body>
  <section style="padding-bottom: 80px;">
    <div class="profile-header" style="text-align: center; margin-bottom: 20px;">
      <img id="profile-image" src="https://placehold.co/100x100" alt="프로필 이미지" style="width: 100px; height: 100px; border-radius: 50%;">
      <h2 id="profile-name">사용자이름</h2>
      <div style="margin-top: 10px;">
        <button id="edit-profile-btn" onclick="location.href='profile.html'" style="display: none;">프로필 수정</button>

        <button id="logout-btn" onclick="logout()" style="display: none; margin-left: 10px;">로그아웃</button>
      </div>
    </div>
    <!-- 소개글 표시 -->
<p id="profile-intro" style="margin-top: 10px; font-size: 0.9rem; color: #555;"></p>

<!-- 편집 버튼 (내 계정일 경우에만 보여줌) -->
<span id="edit-intro-btn" 
      style="display: none; font-size: 0.85rem; color: #888; text-decoration: underline dotted; cursor: pointer;">
  ✏️ 소개글 편집
</span>


<!-- textarea + 저장 버튼 (초기에는 숨김) -->
<div id="intro-edit-area" style="display: none; margin-top: 8px;">
  <textarea id="intro-textarea" rows="2" style="width: 90%; max-width: 400px;"></textarea><br>
  <button onclick="saveIntro()">저장</button>
</div>


    <h3 style="text-align: center;">📸 피드</h3>
    <div id="feeds" class="grid-feed-wrapper"></div>
  </section>

  <div class="bottom-nav">
    <button onclick="location.href='index.html'">🏠</button>
    <button onclick="alert('🔍 검색 준비중')">🔍</button>
    <button onclick="location.href='upload.html'" class="plus-btn">➕</button>
    <button onclick="alert('🎬 릴스 준비중')">🎬</button>
    <button id="profile-nav-btn" onclick="location.href='profile-feed.html'"><img id="nav-profile-img" src="https://placehold.co/32x32" alt="내 프로필" style="width: 32px; height: 32px; border-radius: 50%;"></button>
  </div>

  <script>
    const api = 'https://supermax.kr/feed';
    const params = new URLSearchParams(window.location.search);
    const userId = params.get("userId") || localStorage.getItem("user_id");
    const myUserId = localStorage.getItem("user_id");
    const token = localStorage.getItem("token");

    if (!userId || !token) {
      alert("로그인이 필요합니다.");
      location.href = "login.html";
    }

    async function loadUserProfile() {
  try {
    const res = await fetch(`${api}/user-info`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ user_id: userId })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error("서버 응답 오류: " + text);
    }

    const data = await res.json();
    document.getElementById("profile-name").innerText = data.name || "사용자";
document.getElementById("profile-intro").innerText = data.intro || '';
if (userId === myUserId) {
  document.getElementById("edit-intro-btn").style.display = "inline";
  document.getElementById("edit-intro-btn").onclick = () => {
    // 편집 모드 진입
    document.getElementById("intro-edit-area").style.display = "block";
    document.getElementById("intro-textarea").value = data.intro || '';
  };
}


    document.getElementById("profile-image").src = data.profile_image || "https://placehold.co/100x100";
    // document.getElementById("nav-profile-img").src = data.profile_image || "https://placehold.co/32x32";

    if (userId === myUserId) {
      document.getElementById("edit-profile-btn").style.display = "inline-block";
      document.getElementById("logout-btn").style.display = "inline-block";
    }

  } catch (e) {
    console.error("❌ 유저 정보 불러오기 실패", e);
  }
}
async function saveIntro() {
  const intro = document.getElementById("intro-textarea").value;
  const token = localStorage.getItem("token");

  const res = await fetch("https://supermax.kr/feed/update-profile", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ intro })
  });

  if (res.ok) {
    document.getElementById("profile-intro").innerText = intro;
    document.getElementById("intro-edit-area").style.display = "none";
    alert("소개글이 저장되었습니다!");
  } else {
    alert("소개글 저장 실패");
  }
}



async function loadMyProfileImageForNav() {
  const token = localStorage.getItem("token");
  const userId = localStorage.getItem("user_id");

  if (!token || !userId) return;

  try {
    const res = await fetch("https://supermax.kr/feed/user-info", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ user_id: userId })
    });

    if (!res.ok) {
      const html = await res.text();
      console.warn("❌ 서버 응답 HTML:", html);
      return;
    }

    const data = await res.json();
    document.getElementById("nav-profile-img").src = data.profile_image || "https://placehold.co/32x32";
  } catch (e) {
    console.warn("👤 내 프로필 이미지 불러오기 실패", e);
  }
}



    async function loadFeeds() {
      try {
        const res = await fetch(`${api}/user-feeds/${userId}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const feeds = await res.json();

        const container = document.getElementById("feeds");
        container.innerHTML = feeds.map(feed => {
          let media = '';
          try {
            const mediaArray = JSON.parse(feed.media_url);
            if (Array.isArray(mediaArray) && mediaArray.length > 0) {
              const url = mediaArray[0];
              media = url.includes('.mp4')
                ? `<video src="${url}" muted preload="metadata"></video>`
                : `<img src="${url}" alt="피드 썸네일">`;
            }
          } catch {}
          return `<div class="thumbnail" onclick="location.href='feed-detail.html?feedId=${feed.id}'">${media}</div>`;
        }).join('');
      } catch (e) {
        console.error("피드 불러오기 실패", e);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user_id');
      location.href = 'login.html';
    }

    document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  const userId = new URLSearchParams(location.search).get("userId") || localStorage.getItem("user_id");

  // ✅ 여기에 딱 넣어줘!
  if (!token || !userId) {
    localStorage.setItem("redirect_after_login", location.href);
    alert("로그인이 필요합니다.");
    location.href = "login.html";
    return;
  }
  await loadMyProfileImageForNav();  // ✅ 이게 핵심!
  await loadUserProfile(); // ← 로그인된 상태면 프로필 정보 불러오기
  await loadFeeds();       // ← 유저 피드 출력
});

  </script>
</body>
</html>
